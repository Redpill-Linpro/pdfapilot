<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:context="http://www.springframework.org/schema/context"
  xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
		http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context-3.0.xsd">

  <!-- ####################################################################################################### -->
  <!-- By some strange reason there are errors in Alfresco if the <context:annotation-config /> is being used. -->
  <!-- In order to fix this a AutowiredAnnotationBeanPostProcessor is registered and annotation-config=false -->
  <!-- is configured. If this is done all works fine -->
  <!-- ####################################################################################################### -->
  
  <bean class="org.springframework.beans.factory.annotation.AutowiredAnnotationBeanPostProcessor" />
  <bean class="org.springframework.beans.factory.annotation.InitDestroyAnnotationBeanPostProcessor">
    <property name="initAnnotationType" value="javax.annotation.PostConstruct" />
    <property name="destroyAnnotationType" value="javax.annotation.PreDestroy" />
  </bean>
  <bean class="org.springframework.beans.factory.annotation.RequiredAnnotationBeanPostProcessor" />
  <bean class="org.springframework.context.annotation.ConfigurationClassPostProcessor" />

  <context:component-scan base-package="org.redpill.alfresco.pdfapilot" annotation-config="false" />

  <bean name="ppc.pdfaPilotRenderingEngine" class="org.redpill.alfresco.pdfapilot.worker.PdfaPilotRenderingEngine" parent="baseRenderingAction" />

  <bean name="transformer.worker.abstractPdfaPilot" class="org.redpill.alfresco.pdfapilot.worker.PdfaPilotContentTransformerWorker" abstract="true">
    <property name="endpointHost" value="${pdfapilot.endpoint.host}" />
    <property name="endpointPort" value="${pdfapilot.endpoint.port}" />
    <property name="pdfaPilotExe" value="${pdfapilot.exe}" />
    <property name="documentFormatRegistry" ref="ppc.documentFormatRegistry" />
    <property name="nodeService" ref="NodeService" />
    <property name="metadataContentFactory" ref="metadata-writer.contentFactory" />
    <property name="metadataExtracterRegistry" ref="metadataExtracterRegistry" />
    <property name="executer" ref="pdfaPilot.command" />
    <property name="checkCommand" ref="pdfaPilot.checkCommand" />
    <property name="enabled" value="${pdfapilot.enabled}" />
    <property name="explicitTransformations">
      <list>
        <bean class="org.alfresco.repo.content.transform.ExplictTransformationDetails">
          <property name="sourceMimetype" value="application/pdf" />
          <property name="targetMimetype" value="application/pdf" />
        </bean>
        <bean class="org.alfresco.repo.content.transform.ExplictTransformationDetails">
          <property name="sourceMimetype" value="application/msword" />
          <property name="targetMimetype" value="application/pdf" />
        </bean>
        <bean class="org.alfresco.repo.content.transform.ExplictTransformationDetails">
          <property name="sourceMimetype" value="application/vnd.ms-excel" />
          <property name="targetMimetype" value="application/pdf" />
        </bean>
        <bean class="org.alfresco.repo.content.transform.ExplictTransformationDetails">
          <property name="sourceMimetype" value="application/vnd.ms-powerpoint" />
          <property name="targetMimetype" value="application/pdf" />
        </bean>
        <bean class="org.alfresco.repo.content.transform.ExplictTransformationDetails">
          <property name="sourceMimetype" value="application/vnd.openxmlformats-officedocument.wordprocessingml.document" />
          <property name="targetMimetype" value="application/pdf" />
        </bean>
        <bean class="org.alfresco.repo.content.transform.ExplictTransformationDetails">
          <property name="sourceMimetype" value="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" />
          <property name="targetMimetype" value="application/pdf" />
        </bean>
        <bean class="org.alfresco.repo.content.transform.ExplictTransformationDetails">
          <property name="sourceMimetype" value="application/vnd.openxmlformats-officedocument.presentationml.presentation" />
          <property name="targetMimetype" value="application/pdf" />
        </bean>
        <bean class="org.alfresco.repo.content.transform.ExplictTransformationDetails">
          <property name="sourceMimetype" value="application/vnd.ms-excel.sheet.macroenabled.12" />
          <property name="targetMimetype" value="application/pdf" />
        </bean>
        <bean class="org.alfresco.repo.content.transform.ExplictTransformationDetails">
          <property name="sourceMimetype" value="application/vnd.oasis.opendocument.text" />
          <property name="targetMimetype" value="application/pdf" />
        </bean>
        <bean class="org.alfresco.repo.content.transform.ExplictTransformationDetails">
          <property name="sourceMimetype" value="application/vnd.oasis.opendocument.spreadsheet" />
          <property name="targetMimetype" value="application/pdf" />
        </bean>
        <bean class="org.alfresco.repo.content.transform.ExplictTransformationDetails">
          <property name="sourceMimetype" value="application/vnd.oasis.opendocument.presentation" />
          <property name="targetMimetype" value="application/pdf" />
        </bean>
      </list>
    </property>
  </bean>

  <bean name="transformer.worker.pdfaPilot" class="org.redpill.alfresco.pdfapilot.worker.PdfaPilotContentTransformerWorker" parent="transformer.worker.abstractPdfaPilot">
    <property name="mimetypeService" ref="MimetypeService" />
  </bean>

  <bean name="pdfaPilot.command" class="org.alfresco.util.exec.RuntimeExec">
    <property name="commandsAndArguments">
      <map>
        <entry key=".*">
          <list>
            <value>${pdfapilot.exe}</value>
            <value>--dist</value>
            <value>--endpoint=${pdfapilot.endpoint.host}:${pdfapilot.endpoint.port}</value>
            <value>${source}</value>
            <value>SPLIT:${options}</value>
            <value>--outputfile=${target}</value>
            <value>--overwrite</value>
          </list>
        </entry>
      </map>
    </property>
    <property name="defaultProperties">
      <props>
        <prop key="options"></prop>
      </props>
    </property>
  </bean>

  <bean name="pdfaPilot.checkCommand" class="org.alfresco.util.exec.RuntimeExec">
    <property name="commandsAndArguments">
      <map>
        <entry key=".*">
          <list>
            <value>${pdfapilot.exe}</value>
            <value>--version</value>
          </list>
        </entry>
      </map>
    </property>
  </bean>

</beans>